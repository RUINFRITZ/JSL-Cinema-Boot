<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cinema.mapper.AdminMapper">

    <select id="getTodayRevenue" resultType="Integer">
        SELECT COALESCE(SUM(price), 0) 
        FROM reservation 
        WHERE DATE(rdate) = CURDATE() 
          AND status = 'PAID'
    </select>

    <select id="getTotalMembers" resultType="Integer">
        SELECT COUNT(*) FROM member_cinema
    </select>

    <select id="getActiveMovies" resultType="Integer">
        SELECT COUNT(*) FROM movie
    </select>

    <select id="getRecentReservations" resultType="java.util.Map">
        SELECT 
            r.rno, 
            r.userid, 
            m.title AS movie_title, 
            r.rdate, 
            r.price, 
            r.status 
        FROM reservation r
        JOIN schedule s ON r.sno = s.sno
        JOIN movie m ON s.mno = m.mno
        ORDER BY r.rdate DESC
        LIMIT 5
    </select>

    <select id="selectWeeklyRevenue" resultType="java.util.Map">
        SELECT 
            DATE_FORMAT(MIN(rdate), '%m-%d') AS res_date, 
            SUM(price) AS daily_total
        FROM reservation
        WHERE rdate >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
          AND status = 'PAID'
        GROUP BY DATE(rdate)
        ORDER BY DATE(rdate) ASC
    </select>
    
    <select id="getAllReservations" resultType="java.util.Map">
        SELECT 
            r.rno, 
            r.userid, 
            m.title AS movie_title, 
            r.rdate, 
            r.price, 
            r.status 
        FROM reservation r
        JOIN schedule s ON r.sno = s.sno
        JOIN movie m ON s.mno = m.mno
        ORDER BY r.rdate DESC
    </select>

</mapper>