<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cinema.mapper.MemberMapper">

    <select id="findByUsername" parameterType="string" resultType="com.cinema.domain.Member">
        SELECT
            id,
            userid,
            password,
            name,
            email,
            phone,
            point,
            mgrade,
            role,
            enabled,
            regdate,
            deldate
        FROM
            member_cinema
        WHERE
            userid = #{userid}
    </select>

    <insert id="insertMember" parameterType="com.cinema.domain.Member">
        INSERT INTO member_cinema (
            userid,
            password,
            name,
            email,
            phone,
            role,
            enabled,
            regdate
        ) VALUES (
            #{userid},
            #{password},
            #{name},
            #{email},
            #{phone},
            #{role},
            1,
            NOW()
        )
    </insert>

    <select id="existsById" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM member_cinema
        WHERE userid = #{userid}
    </select>

	<select id="selectCurrentPoint" resultType="int">
        SELECT point FROM member_cinema WHERE userid = #{userid}
    </select>

    <select id="selectPointRate" resultType="double">
        SELECT g.point_rate
        FROM member_cinema m
        JOIN member_grade g ON m.mgrade = g.mgrade
        WHERE m.userid = #{userid}
    </select>

    <update id="updateMemberPoint">
        UPDATE member_cinema
        SET point = point + #{amount}
        WHERE userid = #{userid}
    </update>

    <insert id="insertPointHistory">
        INSERT INTO point_history (
            userid, 
            amount, 
            description, 
            regdate
        ) VALUES (
            #{userid}, 
            #{amount}, 
            #{description}, 
            NOW()
        )
    </insert>
    
    <select id="selectPointHistory" resultType="java.util.Map">
        SELECT pno, amount, description, regdate
        FROM point_history
        WHERE userid = #{userid}
        ORDER BY regdate DESC
    </select>
    
    <update id="updateMemberInfo">
        UPDATE member_cinema
        SET name = #{name},
            phone = #{phone},
            email = #{email}
        WHERE userid = #{userid}
    </update>
    
</mapper>