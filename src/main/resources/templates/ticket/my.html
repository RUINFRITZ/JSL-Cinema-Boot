<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<div layout:fragment="content">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .container {
            padding-top: 52px !important;
            max-width: 1400px !important; 
        }

        /* [重要追加] 表示を隠すユーティリティクラス */
        .d-none { display: none !important; }

        /* ページヘッダー */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0,0,0,0.05);
        }

        /* プロフィールカード */
        .profile-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-item {
            padding: 15px 20px;
            background: rgba(255,255,255,0.5);
            border: 1px solid transparent;
            border-radius: 10px;
            color: #555;
            text-decoration: none;
            font-weight: 600;
            text-align: left;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 107, 0, 0.1);
            border-color: rgba(255, 107, 0, 0.3);
            color: var(--primary-color);
        }

        /* 共通のコンテンツコンテナ (Glassmorphism) */
        .content-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            padding: 40px;
        }

        /* ターブ切り替え用のクラス */
        .tab-content {
            display: none; 
            animation: fadeIn 0.4s ease forwards;
        }
        .tab-content.active {
            display: block; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* チケットグリッド */
        .ticket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .ticket-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            height: 220px;
            transition: all 0.3s;
        }

        .ticket-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 107, 0, 0.15);
        }

        .ticket-poster {
            width: 140px;
            height: 100%;
            object-fit: cover;
            border-right: 1px solid #eee;
        }

        .ticket-info {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            
            /* [重要追加] Flexbox内で text-overflow: ellipsis を効かせるための必須設定 */
            min-width: 0; 
        }

        /* 過去のチケット (グレースケール処理) */
        .past-ticket { filter: grayscale(100%); opacity: 0.6; }
        .past-ticket:hover { filter: grayscale(0%); opacity: 1; }

        .btn-toggle {
            background: #fff;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 30px;
            color: #555;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-toggle:hover { border-color: var(--primary-color); color: var(--primary-color); }

        /* フォーム要素のスタイリング */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; font-size: 0.95rem; }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: rgba(255,255,255,0.7);
            font-size: 1rem;
            color: #333;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }
    </style>

    <div class="container">
        
        <div class="page-header">
            <h2 style="margin: 0; font-weight: 800; color: #333;">
                <i class="fa-solid fa-user-circle" style="color: var(--primary-color); margin-right: 10px;"></i>
                マイページ
            </h2>
        </div>

        <div style="display: flex; gap: 30px; align-items: flex-start;">
            
            <div style="width: 300px; flex-shrink: 0;">
                <div class="profile-card">
                    <i class="fa-solid fa-circle-user" style="font-size: 4rem; color: #ccc; margin-bottom: 15px;"></i>
                    <h4 style="font-weight: 800; margin-bottom: 5px;"><span th:text="${member != null ? member.name : userid}">User</span> 様</h4>
                    
                    <p style="color: #888; font-size: 0.9rem; margin-bottom: 20px; font-weight: bold;">
                        <span th:if="${member != null and member.mgrade == 0}" style="color: #dc3545;"><i class="fa-solid fa-gear"></i> ADMIN</span>
                        <span th:if="${member != null and member.mgrade == 1}">MEMBER</span>
                        <span th:if="${member != null and member.mgrade == 2}" style="color: #17a2b8;">VIP</span>
                        <span th:if="${member != null and member.mgrade == 3}" style="color: #0d6efd;">VVIP</span>
                        <span th:if="${member != null and member.mgrade == 4}" style="color: #ffc107;"><i class="fa-solid fa-trophy"></i> MVP</span>
                    </p>
                    
                    <div style="background: rgba(255,107,0,0.1); color: var(--primary-color); padding: 10px; border-radius: 8px; font-weight: 800; font-size: 1.2rem;">
                        <span th:text="${member != null ? #numbers.formatInteger(member.point, 1, 'COMMA') : 0}">0</span> P
                    </div>
                </div>

                <div class="nav-menu">
                    <div class="nav-item active" onclick="switchTab('tickets', this)"><i class="fa-solid fa-ticket" style="width:25px;"></i> マイチケット</div>
                    <div class="nav-item" onclick="switchTab('points', this)"><i class="fa-solid fa-coins" style="width:25px;"></i> ポイント履歴</div>
                    <div class="nav-item" onclick="switchTab('info', this)"><i class="fa-solid fa-user-pen" style="width:25px;"></i> 基本情報変更</div>
                </div>
            </div>

            <div style="flex-grow: 1;">
                
                <div id="tab-tickets" class="tab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="font-weight: 800; margin: 0;">予約チケット一覧</h4>
                        <button class="btn-toggle" id="togglePastBtn" onclick="togglePastTickets()">
                            <i class="fa-solid fa-clock-rotate-left"></i> 過去の履歴も表示
                        </button>
                    </div>

                    <div class="ticket-grid" id="ticketContainer">
                        
                        <div th:each="ticket : ${ticketList}" 
                             th:class="'ticket-card ' + (${ticket.sdate.isBefore(#temporals.createNow())} ? 'past-ticket d-none' : '')">
                            <img th:src="@{'/upload/' + ${ticket.poster}}" class="ticket-poster" alt="Poster" onerror="this.src='/images/default_poster.jpg'">
                            <div class="ticket-info">
                                <div style="min-width: 0;">
                                    <h5 style="font-weight: 800; font-size: 1.2rem; margin: 0 0 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;" 
                                        th:text="${ticket.title}">タイトル</h5>
                                    <span style="font-size: 0.8rem; color: #aaa; font-family: monospace;">No. <span th:text="${ticket.rno}">0000</span></span>
                                </div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <div style="margin-bottom: 3px;"><i class="fa-solid fa-location-dot" style="width:15px;"></i> <span th:text="${ticket.tname}">1館</span></div>
                                    <div style="margin-bottom: 3px;" th:class="${ticket.sdate.isBefore(#temporals.createNow())} ? 'text-danger' : ''">
                                        <i class="fa-regular fa-calendar" style="width:15px;"></i> <span th:text="${#temporals.format(ticket.sdate, 'yyyy-MM-dd HH:mm')}">2026-02-21 14:30</span>
                                    </div>
                                    <div><i class="fa-solid fa-chair" style="width:15px;"></i> 座席: <strong th:text="${ticket.seat_info}">A-1</strong></div>
                                </div>
                                <div style="text-align: right; margin-top: 10px;">
                                    <span th:if="${ticket.sdate.isBefore(#temporals.createNow())}" class="badge" style="background: #999; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem;">観覧完了</span>
                                    <span th:unless="${ticket.sdate.isBefore(#temporals.createNow())}" class="badge" style="background: var(--primary-color); color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem;">予約完了</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="emptyMessage" class="d-none" style="grid-column: 1 / -1; text-align: center; padding: 60px; background: rgba(255,255,255,0.5); border-radius: 16px;">
                            <i class="fa-solid fa-ticket-simple" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                            <p style="color: #666; font-size: 1.1rem; margin-bottom: 20px;">現在、観覧予定のチケットはありません。</p>
                            <a href="/ticket/reserve" class="btn-primary" style="padding: 10px 25px; border-radius: 8px; text-decoration: none;">映画を予約する</a>
                        </div>
                    </div>
                </div>

                <div id="tab-points" class="tab-content">
                    <div class="content-panel">
                        <h4 style="font-weight: 800; margin: 0 0 25px 0;"><i class="fa-solid fa-coins" style="color: var(--primary-color);"></i> ポイント利用・獲得履歴</h4>
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--primary-color); color: #333;">
                                    <th style="padding: 15px; font-weight: 800;">処理日時</th>
                                    <th style="padding: 15px; font-weight: 800;">内容</th>
                                    <th style="padding: 15px; font-weight: 800; text-align: right;">変動ポイント</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="p : ${pointList}" style="border-bottom: 1px solid #eee; transition: background 0.2s;">
                                    <td style="padding: 15px; color: #888; font-size: 0.95rem;" th:text="${#temporals.format(p.regdate, 'yyyy-MM-dd HH:mm')}">日時</td>
                                    <td style="padding: 15px; font-weight: 600; color: #555;" th:text="${p.description}">内容</td>
                                    <td style="padding: 15px; text-align: right; font-weight: 800; font-size: 1.1rem;" 
                                        th:style="${p.amount > 0 ? 'color: #28a745;' : 'color: #dc3545;'}"
                                        th:text="${(p.amount > 0 ? '+' : '') + #numbers.formatInteger(p.amount, 1, 'COMMA') + ' P'}">
                                        +0 P
                                    </td>
                                </tr>
                                <tr th:if="${pointList == null or pointList.isEmpty()}">
                                    <td colspan="3" style="padding: 50px; text-align: center; color: #999;">ポイントの履歴がありません。</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-info" class="tab-content">
                    <div class="content-panel" style="max-width: 600px; margin: 0 auto;">
                        <h4 style="font-weight: 800; margin: 0 0 25px 0;"><i class="fa-solid fa-user-pen" style="color: var(--primary-color);"></i> 会員情報の変更</h4>
                        <form action="/member/update" method="post" th:if="${member != null}">
                            <input type="hidden" name="userid" th:value="${member.userid}">
                            <div class="form-group">
                                <label>ログインID (変更不可)</label>
                                <input type="text" class="form-control" th:value="${member.userid}" disabled style="background: #f8f9fa; color: #999;">
                            </div>
                            <div class="form-group">
                                <label>お名前</label>
                                <input type="text" name="name" class="form-control" th:value="${member.name}" required>
                            </div>
                            <div class="form-group">
                                <label>電話番号</label>
                                <input type="text" name="phone" class="form-control" th:value="${member.phone}">
                            </div>
                            <div class="form-group">
                                <label>メールアドレス</label>
                                <input type="email" name="email" class="form-control" th:value="${member.email}" required>
                            </div>
                            <div style="text-align: right; margin-top: 30px;">
                                <button type="submit" class="btn-primary" style="padding: 12px 30px; border-radius: 8px;">保存する</button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // 1. DOM読み込み完了時に表示・非表示の初期チェックを実行
        document.addEventListener('DOMContentLoaded', function() {
            checkVisibleTickets();

            // トースト通知処理
            const successMsg = /*[[${successMsg}]]*/ null;
            if (successMsg) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: successMsg,
                    showConfirmButton: false,
                    timer: 2222
                });
            }
        });

        // 2. タブ切り替えロジック
        function switchTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        // 3. 過去チケットの表示・非表示トグル処理
        function togglePastTickets() {
            const pastTickets = document.querySelectorAll('.past-ticket');
            const btn = document.getElementById('togglePastBtn');
            
            if (pastTickets.length === 0) return;
            const isHidden = pastTickets[0].classList.contains('d-none');

            pastTickets.forEach(ticket => {
                if (isHidden) { ticket.classList.remove('d-none'); } 
                else { ticket.classList.add('d-none'); }
            });

            // ボタンのUI更新
            if (isHidden) {
                btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> 過去の履歴を隠す';
                btn.style.borderColor = 'var(--primary-color)';
                btn.style.color = 'var(--primary-color)';
            } else {
                btn.innerHTML = '<i class="fa-solid fa-clock-rotate-left"></i> 過去の履歴も表示';
                btn.style.borderColor = '#ccc';
                btn.style.color = '#555';
            }

            // トグル後にも空表示チェックを実行
            checkVisibleTickets();
        }

        // 4. [重要追加] 画面に表示されているチケットがあるか確認し、空表示を制御
        function checkVisibleTickets() {
            const allTickets = document.querySelectorAll('.ticket-card');
            const hiddenTickets = document.querySelectorAll('.ticket-card.d-none');
            const emptyMsg = document.getElementById('emptyMessage');
            
            if(emptyMsg) {
                // チケットが全くない場合、または「すべて過去のチケット(非表示状態)」の場合
                if (allTickets.length === 0 || allTickets.length === hiddenTickets.length) {
                    emptyMsg.classList.remove('d-none');
                } else {
                    emptyMsg.classList.add('d-none');
                }
            }
        }
        /*]]>*/
    </script>

</div>
</html>